# Test Design: Story 1.3 - Command Template Discovery

Date: 2025-09-01
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 18
- **Unit tests**: 12 (67%)
- **Integration tests**: 4 (22%)
- **E2E tests**: 2 (11%)
- **Priority distribution**: P0: 8, P1: 6, P2: 3, P3: 1

**Strategy Rationale**: Function-focused testing with emphasis on unit tests for core logic, integration tests for file system operations, and minimal E2E for CLI workflow validation.

## Test Scenarios by Acceptance Criteria

### AC1: Search `.promptcraft/commands/` in current working directory first

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-UNIT-001 | Unit        | P0       | Construct current directory path        | Core path construction logic         |
| 1.3-UNIT-002 | Unit        | P0       | Validate command name to filename       | Input validation critical for security |
| 1.3-UNIT-003 | Unit        | P1       | Handle invalid command names            | Error handling for malformed input   |
| 1.3-INT-001  | Integration | P0       | Find template in current directory      | File system interaction validation   |
| 1.3-INT-002  | Integration | P1       | Handle missing current directory        | Edge case for directory existence    |

### AC2: Fallback to `.promptcraft/commands/` in user home directory

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-UNIT-004 | Unit        | P0       | Construct home directory path           | Core fallback logic                  |
| 1.3-UNIT-005 | Unit        | P1       | Validate search order logic             | Hierarchical search correctness      |
| 1.3-INT-003  | Integration | P0       | Fallback to home when current missing   | Critical path for template discovery |
| 1.3-INT-004  | Integration | P2       | Handle missing home directory           | Edge case handling                   |

### AC3: Return pathlib.Path object for found template file

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-UNIT-006 | Unit        | P0       | Return correct Path object type         | API contract validation              |
| 1.3-UNIT-007 | Unit        | P0       | Path object points to correct file      | Result accuracy critical             |
| 1.3-UNIT-008 | Unit        | P2       | Path object is absolute vs relative     | Implementation detail verification   |

### AC4: Raise CommandNotFoundError if not found in either location

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-UNIT-009 | Unit        | P0       | Raise correct exception type            | Exception contract validation        |
| 1.3-UNIT-010 | Unit        | P0       | Exception contains helpful message      | Developer experience critical        |
| 1.3-UNIT-011 | Unit        | P1       | Exception doesn't expose sensitive paths | Security consideration              |

### AC5: Handle edge cases like missing directories gracefully

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-UNIT-012 | Unit        | P1       | Handle permission denied errors         | Robust error handling                |
| 1.3-UNIT-013 | Unit        | P2       | Handle filesystem race conditions       | Edge case resilience                |
| 1.3-E2E-001  | E2E         | P1       | Complete CLI workflow with templates    | End-to-end validation                |

### AC6: Accept command name parameter and construct correct `.md` filename

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-UNIT-014 | Unit        | P0       | Construct proper .md filename           | Core filename logic                  |
| 1.3-UNIT-015 | Unit        | P0       | Handle special characters in names      | Input sanitization critical          |
| 1.3-E2E-002  | E2E         | P3       | CLI integration with filename handling  | Complete workflow validation         |

## Security Test Scenarios (Based on Risk Profile)

### Path Traversal Prevention (TECH-001)

| ID              | Level       | Priority | Test                                    | Justification                        |
| --------------- | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-SEC-001     | Unit        | P0       | Block "../" in command names            | Critical security vulnerability      |
| 1.3-SEC-002     | Unit        | P0       | Block absolute paths in command names   | Prevent directory traversal          |
| 1.3-SEC-003     | Unit        | P0       | Block null bytes in command names       | Input validation security            |
| 1.3-SEC-004     | Unit        | P0       | Validate against command name whitelist | Proactive security measure           |

## Cross-Platform Compatibility Tests

| ID              | Level       | Priority | Test                                    | Justification                        |
| --------------- | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.3-CROSS-001   | Integration | P1       | Windows path handling                   | Platform compatibility               |
| 1.3-CROSS-002   | Integration | P1       | macOS path handling                     | Platform compatibility               |
| 1.3-CROSS-003   | Integration | P1       | Linux path handling                     | Platform compatibility               |
| 1.3-CROSS-004   | Integration | P2       | Unicode characters in paths             | International compatibility          |

## Test Implementation Recommendations

### Unit Test Suite (`tests/unit/test_core.py`)

**Framework**: pytest
**Mock Strategy**: Mock file system operations using `unittest.mock.patch`
**Key Patterns**:

```python
def test_find_command_path_current_directory_success():
    # Test AC1: Find in current directory
    
def test_find_command_path_security_traversal_blocked():
    # Test security: Prevent path traversal
    
def test_find_command_path_fallback_to_home():
    # Test AC2: Fallback behavior
```

### Integration Test Suite (`tests/integration/test_file_operations.py`)

**Framework**: pytest with temporary directories
**Setup**: Create real test directory structures
**Key Patterns**:

```python
@pytest.fixture
def temp_command_structure():
    # Create real .promptcraft/commands/ structure
    
def test_actual_file_discovery():
    # Test with real files and directories
```

### Security Test Suite (`tests/security/test_path_validation.py`)

**Framework**: pytest with parameterized tests
**Focus**: Input validation and path traversal prevention
**Key Patterns**:

```python
@pytest.mark.parametrize("malicious_input", [
    "../../../etc/passwd",
    "/absolute/path",
    "command\x00name",
    "command/../other"
])
def test_malicious_command_names_blocked(malicious_input):
    # Verify all malicious inputs are rejected
```

## Risk Coverage Mapping

### Critical Risk Mitigation (TECH-001: Path Traversal)

- **1.3-SEC-001 through 1.3-SEC-004**: Complete coverage of security vulnerability
- **1.3-UNIT-002, 1.3-UNIT-015**: Input validation testing
- **Priority**: All P0 - must pass before production

### Medium Risk Mitigation

- **TECH-002 (Race Conditions)**: Covered by 1.3-UNIT-013
- **BUS-001 (Consistency)**: Covered by 1.3-UNIT-005, 1.3-E2E-001
- **TECH-003 (Cross-Platform)**: Covered by 1.3-CROSS-001 through 1.3-CROSS-004

## Recommended Execution Order

### Phase 1: Critical Security (Must Pass)
1. **1.3-SEC-001** through **1.3-SEC-004** (Path traversal prevention)
2. **1.3-UNIT-002, 1.3-UNIT-015** (Input validation)

### Phase 2: Core Functionality (P0)
3. **1.3-UNIT-001, 1.3-UNIT-004** (Path construction)
4. **1.3-UNIT-006, 1.3-UNIT-007** (Return value validation)
5. **1.3-UNIT-009, 1.3-UNIT-010** (Exception handling)
6. **1.3-INT-001, 1.3-INT-003** (File system operations)

### Phase 3: Integration & Cross-Platform (P1)
7. **1.3-CROSS-001** through **1.3-CROSS-003** (Platform compatibility)
8. **1.3-E2E-001** (Complete workflow)

### Phase 4: Edge Cases & Polish (P2+)
9. Remaining P2 and P3 tests as time permits

## Test Environment Requirements

### Unit Tests
- **Dependencies**: pytest, unittest.mock
- **Setup**: No external dependencies
- **Runtime**: <1 second total

### Integration Tests
- **Dependencies**: pytest, tempfile, pathlib
- **Setup**: Temporary directory creation
- **Runtime**: <5 seconds total

### Cross-Platform Tests
- **Dependencies**: Platform-specific CI/CD runners
- **Setup**: Windows, macOS, Linux test environments
- **Runtime**: <10 seconds per platform

### Security Tests
- **Dependencies**: pytest with parameterized testing
- **Setup**: Malicious input generation
- **Runtime**: <2 seconds total

## Coverage Gaps Analysis

**✅ Complete Coverage**: All acceptance criteria have corresponding tests
**✅ Security Coverage**: Path traversal vulnerability fully addressed
**✅ Platform Coverage**: Cross-platform compatibility validated
**✅ Error Coverage**: All error conditions tested

**No coverage gaps identified** - all requirements mapped to appropriate test scenarios.

## Maintenance Considerations

### Test Stability
- Unit tests: High stability (no external dependencies)
- Integration tests: Medium stability (file system dependent)
- E2E tests: Lower stability (full workflow dependent)

### Test Maintenance
- **Low maintenance**: Security and unit tests
- **Medium maintenance**: Integration tests (may need path updates)
- **High maintenance**: E2E tests (may break with CLI changes)

## Success Criteria

### Minimum Viable Testing
- All P0 tests must pass
- Security tests must pass with 100% coverage
- At least one cross-platform test must pass

### Comprehensive Testing
- 95%+ unit test coverage on function logic
- All integration scenarios validated
- Cross-platform compatibility confirmed
- Security vulnerability completely mitigated

### Quality Gate Integration
- Test design supports CONCERNS → PASS gate progression
- Security risk (TECH-001) directly addressed
- All critical acceptance criteria validated